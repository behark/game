<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Rivals - 3D Racing Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            font-family: 'Arial', sans-serif;
            overflow: hidden;
        }

        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #gameCanvas {
            display: block;
            cursor: crosshair;
        }

        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 18px;
            z-index: 100;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        #controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 100;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            z-index: 200;
            text-align: center;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="loading">
            <div>üèéÔ∏è Loading Speed Rivals 3D...</div>
            <div id="status">Initializing...</div>
        </div>

        <div id="ui" class="hidden">
            <div id="speed">Speed: <span id="speedValue">0</span> km/h</div>
            <div id="lap">Lap: <span id="lapValue">1</span>/3</div>
            <div id="position">Position: <span id="positionValue">1</span>/4</div>
        </div>

        <div id="controls" class="hidden">
            <div><strong>Controls:</strong></div>
            <div>W/‚Üë - Accelerate</div>
            <div>S/‚Üì - Brake/Reverse</div>
            <div>A/‚Üê - Turn Left</div>
            <div>D/‚Üí - Turn Right</div>
            <div>Space - Handbrake</div>
        </div>

        <canvas id="gameCanvas"></canvas>
    </div>

    <!-- Use CDN version that we know works -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // Game variables
        let scene, camera, renderer;
        let car, carGroup;
        let keys = {};
        let carSpeed = 0;
        let carAngle = 0;
        const maxSpeed = 0.8;
        const acceleration = 0.03;
        const turnSpeed = 0.04;
        const friction = 0.02;

        // Update status
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            console.log('üéÆ', message);
        }

        // Initialize game
        function initGame() {
            updateStatus('Creating 3D scene...');

            // Create scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB); // Sky blue

            // Create camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 10, 15);

            // Create renderer
            renderer = new THREE.WebGLRenderer({
                canvas: document.getElementById('gameCanvas'),
                antialias: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            updateStatus('Adding lights...');

            // Add lights
            const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(50, 50, 25);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);

            updateStatus('Creating track...');

            // Create ground
            const groundGeometry = new THREE.PlaneGeometry(200, 200);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x4a7c59 });
            const groundMesh = new THREE.Mesh(groundGeometry, groundMaterial);
            groundMesh.rotation.x = -Math.PI / 2;
            groundMesh.receiveShadow = true;
            scene.add(groundMesh);

            // Create track
            const trackGeometry = new THREE.RingGeometry(25, 45, 32);
            const trackMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });
            const trackMesh = new THREE.Mesh(trackGeometry, trackMaterial);
            trackMesh.rotation.x = -Math.PI / 2;
            trackMesh.position.y = 0.01;
            trackMesh.receiveShadow = true;
            scene.add(trackMesh);

            // Add track markings
            const lineGeometry = new THREE.RingGeometry(34, 36, 32);
            const lineMaterial = new THREE.MeshLambertMaterial({ color: 0xffffff });
            const lineMesh = new THREE.Mesh(lineGeometry, lineMaterial);
            lineMesh.rotation.x = -Math.PI / 2;
            lineMesh.position.y = 0.02;
            scene.add(lineMesh);

            updateStatus('Creating car...');

            // Create car
            carGroup = new THREE.Group();

            // Car body
            const bodyGeometry = new THREE.BoxGeometry(2, 0.8, 4);
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0xff4444 });
            const bodyMesh = new THREE.Mesh(bodyGeometry, bodyMaterial);
            bodyMesh.position.y = 0.4;
            bodyMesh.castShadow = true;
            carGroup.add(bodyMesh);

            // Car roof
            const roofGeometry = new THREE.BoxGeometry(1.6, 0.6, 2);
            const roofMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });
            const roofMesh = new THREE.Mesh(roofGeometry, roofMaterial);
            roofMesh.position.y = 1;
            roofMesh.castShadow = true;
            carGroup.add(roofMesh);

            // Car wheels
            const wheelGeometry = new THREE.CylinderGeometry(0.3, 0.3, 0.2, 16);
            const wheelMaterial = new THREE.MeshLambertMaterial({ color: 0x222222 });

            const wheelPositions = [
                { x: -0.9, y: 0, z: 1.3 },   // Front left
                { x: 0.9, y: 0, z: 1.3 },    // Front right
                { x: -0.9, y: 0, z: -1.3 },  // Rear left
                { x: 0.9, y: 0, z: -1.3 }    // Rear right
            ];

            wheelPositions.forEach(pos => {
                const wheelMesh = new THREE.Mesh(wheelGeometry, wheelMaterial);
                wheelMesh.position.set(pos.x, pos.y, pos.z);
                wheelMesh.rotation.z = Math.PI / 2;
                wheelMesh.castShadow = true;
                carGroup.add(wheelMesh);
            });

            // Headlights
            const lightGeometry = new THREE.SphereGeometry(0.15, 8, 8);
            const lightMaterial = new THREE.MeshLambertMaterial({
                color: 0xffffcc,
                emissive: 0x444422
            });

            const leftLight = new THREE.Mesh(lightGeometry, lightMaterial);
            leftLight.position.set(-0.6, 0.5, 1.9);
            carGroup.add(leftLight);

            const rightLight = new THREE.Mesh(lightGeometry, lightMaterial);
            rightLight.position.set(0.6, 0.5, 1.9);
            carGroup.add(rightLight);

            // Taillights
            const tailMaterial = new THREE.MeshLambertMaterial({
                color: 0xff0000,
                emissive: 0x220000
            });

            const leftTail = new THREE.Mesh(lightGeometry, tailMaterial);
            leftTail.position.set(-0.6, 0.5, -1.9);
            carGroup.add(leftTail);

            const rightTail = new THREE.Mesh(lightGeometry, tailMaterial);
            rightTail.position.set(0.6, 0.5, -1.9);
            carGroup.add(rightTail);

            // Position car on track
            carGroup.position.set(0, 0.1, -30);
            scene.add(carGroup);

            updateStatus('Setting up controls...');

            // Setup controls
            window.addEventListener('keydown', (e) => {
                keys[e.code] = true;
                if (e.code === 'Space') e.preventDefault();
            });

            window.addEventListener('keyup', (e) => {
                keys[e.code] = false;
            });

            // Handle resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            updateStatus('Starting engines! üèÅ');

            // Hide loading, show game
            setTimeout(() => {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('ui').classList.remove('hidden');
                document.getElementById('controls').classList.remove('hidden');

                // Start game loop
                gameLoop();
            }, 1000);
        }

        // Update game logic
        function updateGame() {
            // Handle input
            if (keys['KeyW'] || keys['ArrowUp']) {
                carSpeed = Math.min(carSpeed + acceleration, maxSpeed);
            }
            if (keys['KeyS'] || keys['ArrowDown']) {
                carSpeed = Math.max(carSpeed - acceleration, -maxSpeed / 2);
            }
            if (keys['KeyA'] || keys['ArrowLeft']) {
                carAngle -= turnSpeed * Math.abs(carSpeed / maxSpeed);
            }
            if (keys['KeyD'] || keys['ArrowRight']) {
                carAngle += turnSpeed * Math.abs(carSpeed / maxSpeed);
            }
            if (keys['Space']) {
                carSpeed *= 0.9; // Handbrake
            }

            // Apply friction
            carSpeed *= (1 - friction);

            // Update car position
            carGroup.position.x += Math.sin(carAngle) * carSpeed;
            carGroup.position.z += Math.cos(carAngle) * carSpeed;
            carGroup.rotation.y = carAngle;

            // Update camera to follow car
            const cameraDistance = 20;
            const cameraHeight = 12;
            const targetX = carGroup.position.x - Math.sin(carAngle) * cameraDistance;
            const targetZ = carGroup.position.z - Math.cos(carAngle) * cameraDistance;

            camera.position.lerp(
                new THREE.Vector3(targetX, carGroup.position.y + cameraHeight, targetZ),
                0.1
            );
            camera.lookAt(carGroup.position.x, carGroup.position.y + 2, carGroup.position.z);

            // Update UI
            document.getElementById('speedValue').textContent = Math.round(Math.abs(carSpeed) * 120);
        }

        // Game loop
        function gameLoop() {
            updateGame();
            renderer.render(scene, camera);
            requestAnimationFrame(gameLoop);
        }

        // Start initialization
        updateStatus('Loading Three.js...');

        // Check if Three.js loaded
        if (typeof THREE !== 'undefined') {
            updateStatus('Three.js loaded! Initializing game...');
            setTimeout(initGame, 500);
        } else {
            updateStatus('‚ùå Three.js failed to load');
            setTimeout(() => {
                updateStatus('Trying alternative loading method...');
                location.reload();
            }, 2000);
        }
    </script>
</body>
</html>